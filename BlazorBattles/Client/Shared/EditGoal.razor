@inject IGoalService GoalService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager;

@attribute [Authorize]


@if (isCalendarVisible)
{
    <span style="background-color: navajowhite;">To fullfil goal <b>@goal.Name</b> is planned reach <b>@goal.TotalValue @goal.Unit</b> spread over <b>@goal.Days.Count</b> days.</span>

    <br />

    currentCalendarDay = firstCalendarDay;
    dayIndex = 0;
    lastPrintedMonth = -1;
    cumulativeValue = 0;

    lastCheckedValue = 0;
    cumulativeValues = new List<int>();
    checkedValues = new List<int?>();
    dates = new List<String>();
    int i = 0;


    <table class="table" style="max-width : 1000px">
        <thead>
            <tr>
                <th width="14%">Monday</th>
                <th width="14%">TuesDay</th>
                <th width="14%">Wednesday</th>
                <th width="14%">Thursday</th>
                <th width="14%">Friday</th>
                <th width="14%">Saturday</th>
                <th width="14%">Sunday</th>
            </tr>
        </thead>
        <tbody>

            @while (currentCalendarDay <= endCalendarDay)
            {
                @if (lastPrintedMonth != currentCalendarDay.Month)
                {
                    <tr>
                        <td colspan="7"><h3>@currentCalendarDay.ToString("MMMM yyyy")</h3></td>
                    </tr>
                    lastPrintedMonth = currentCalendarDay.Month;
                }
                <tr>
                    @for (int j = 0; j < 7; j++)
                    {
                        @if (currentCalendarDay < startCalendarDay || currentCalendarDay > endCalendarDay)
                        {
                            <td style="color: grey; font-weight: 200;"> @currentCalendarDay.ToString("dd")</td>
                        }
                        else
                        {
                            DateTime cellCalendarDay = currentCalendarDay;
                            Tuple<string, int> styleAndCumulativeValue = GetStyleCumulativeValueAndDecideIfIsDayInGoal(currentCalendarDay);
                            String currentCellStyle = styleAndCumulativeValue.Item1;
                            int currentCellCumulativeValue = styleAndCumulativeValue.Item2;

                            <td style=@currentCellStyle @onclick="() => CellClicked(cellCalendarDay,currentCellCumulativeValue)">
                                <span>@currentCalendarDay.ToString("dd"). </span>
                                @if (isDayInGoal)
                                {

                                    <span style="background-color: navajowhite">@currentGoalDay.Value/@cumulativeValue @goal.Unit </span>
                                    @if (!currentGoalDay.IsAllDay)
                                    {
                                        <br /><span style="font-weight: 300; font-style : italic; align-self : center">@currentGoalDay.StartDate.ToString("HH:mm") - @((currentGoalDay.StartDate + currentGoalDay.LengthTime).ToString("HH:mm"))</span>
                                    }
                                    <div class="note">@currentGoalDay.Note</div>
                                    <div class="note">@currentGoalDay.CheckedValue</div>
                                }

                                @if (isDayInGoal)
                                {
                                    int iCopy = i;
                                    i++;

                                    <input type="checkbox" checked=@checkboxesChecked[iCopy]
                                           @onchange="eventArgs => { CheckboxClicked(iCopy, eventArgs.Value); }" /> <br />
                                }

                            </td>

                        }
                        currentCalendarDay = currentCalendarDay.AddDays(1);
                    }
                </tr>

            }
        </tbody>
    </table>

    <br />
    @if (!isInCheck)
    {
        @if (isInEdit)
        {
            <button class="btn btn-primary" @onclick="SaveChangesHandler">Save Changes</button>
            <button class="btn btn-secondary" @onclick="CloseChangesHandler">Close Changes</button>
        }
        else
        {
            <button class="btn btn-primary" @onclick="CreateGoalHandler">Create Goal</button>
        }
        @if (isInCheck)
        {
            <div>Is in Check</div>
        }
    }

    <div id="graph-container" style="max-width:1000px">
        <canvas id="myChart"></canvas>
    </div>

}

<Modal @ref="Modal" editGoalDay="modalGoalDay" isInEdit="isModalInEditMode" OnCreateButtonClicked="createGoalDay" OnDeleteButtonClicked="deleteGoalDay" OnGoalDayChanged="Refresh" OnValueChanged="recalculate"></Modal>
<ModalCheck @ref="ModalCheck" checkGoalDay="modalGoalDay" checkCumulativeValue="modalCumulativeValue" OnGoalDayChanged="Refresh"></ModalCheck>


@code {


    [Parameter]
    public bool isInCheck { get; set; }

    [Parameter]
    public bool isInEdit { get; set; }
    [Parameter]
    public Goal goal { get; set; } = null;
    [Parameter]
    public EventCallback onCloseChanges { get; set; }

    // Goal originalGoal { get; set; }

    private bool isCalendarVisible { get; set; } = false;
    private DateTime currentCalendarDay { get; set; }

    private DateTime firstCalendarDay { get; set; }
    private DateTime startCalendarDay { get; set; }
    private DateTime endCalendarDay { get; set; }

    private GoalDay currentGoalDay { get; set; } = null;
    private bool isDayInGoal { get; set; }

    int? lastCheckedValue = 0;
    int cumulativeValue = 0;
    int modalCumulativeValue = 0;

    private int lastPrintedMonth = -1;
    int dayIndex = 0;

    private Modal Modal { get; set; }
    private ModalCheck ModalCheck { get; set; }

    private GoalDay modalGoalDay { get; set; } = new GoalDay();
    public bool isModalInEditMode { get; set; }

    List<int> cumulativeValues = new List<int>();
    List<int?> checkedValues = new List<int?>();
    List<String> dates = new List<String>();
    
    bool[] checkboxesChecked;


    public void CheckboxClicked(int i, object aChecked)
    {
        if ((bool)aChecked)
        {
            checkboxesChecked[i] = true;
        }
        else
        {
            checkboxesChecked[i] = false;
        }

        StateHasChanged();
    }


    private void editMultiple()
    {

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (goal == null)
        {
            return;
        }

        if (!isInEdit)
        {
            await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues);
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues);
            await JSRuntime.InvokeVoidAsync("addCheckedValues", checkedValues);
        }



        /*
        if (firstRender && goal != null)
        //if(firstRender)
        {
            await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues, checkedValues);

        }

        else if (firstRenderAfterEdit)
        {

            await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues, checkedValues);
            firstRenderAfterEdit = false;
        }
        */

    }


    public async void CreateGoalHandler()
    {
        await GoalService.AddGoal(goal);
        //await GoalService.LoadGoals();
        NavigationManager.NavigateTo("dashboard", true);

    }

    public async void SaveChangesHandler()
    {
        await GoalService.EditGoal(goal);
        await onCloseChanges.InvokeAsync();

    }

    public async void CloseChangesHandler()
    {
        onCloseChanges.InvokeAsync();
    }


    private Tuple<string, int>
    GetStyleCumulativeValueAndDecideIfIsDayInGoal(DateTime currentCalendarDay)
    {
        dates.Add(currentCalendarDay.Date.ToShortDateString());
        if (dayIndex == goal.Days.Count)
        {
            checkedValues.Add(lastCheckedValue); // mozna je navic
            cumulativeValues.Add(cumulativeValue); // mozna je navic
            isDayInGoal = false;
            if (isInCheck)
            {

                return new Tuple<string, int>
                    ("color: grey; font - weight: 200; ", cumulativeValue);
            }
            else
            {
                return new Tuple<string, int>
                    ("border: 2px dashed black; font-weight: 400;cursor: pointer;", cumulativeValue);
            }
        }

        currentGoalDay = goal.Days.ElementAt(dayIndex);
        //Console.WriteLine("note:" + currentGoalDay.Note);

        if (currentGoalDay.StartDate.Date == currentCalendarDay.Date) // !day is goalDay
        {
            if (currentGoalDay.CheckedValue != null)
            {
                lastCheckedValue = currentGoalDay.CheckedValue;
            }
            cumulativeValue += currentGoalDay.Value;
            isDayInGoal = true;
            dayIndex++;

            checkedValues.Add(lastCheckedValue);
            cumulativeValues.Add(cumulativeValue);

            if (isInCheck)
            {

                return new Tuple<string, int>
                    ("border: 1px solid black; background-color: Orange; font-weight: 600; cursor: pointer;", cumulativeValue);
            }
            else
            {
                return new Tuple<string, int>
                    ("border: 2px solid black; background-color: PaleGreen; font-weight: 600; cursor: pointer;", cumulativeValue);
            }
        }

        checkedValues.Add(lastCheckedValue);
        cumulativeValues.Add(cumulativeValue);

        isDayInGoal = false;
        if (isInCheck)
        {

            return new Tuple<string, int>
                ("color: grey; font - weight: 200; ", cumulativeValue);
        }
        else
        {
            return new Tuple<string, int>
                ("border: 2px dashed black; font-weight: 400;cursor: pointer;", cumulativeValue);
        }
    }


    private void CellClicked(DateTime currentDay, int currentCellcumulativeValue)
    {
        GoalDay tempGoalDay = goal.Days.FirstOrDefault(goalDay => goalDay.StartDate.Date.Equals(currentDay.Date));
        if (tempGoalDay != null && isInCheck)
        {
            modalCumulativeValue = currentCellcumulativeValue;
            modalGoalDay = tempGoalDay;
            isModalInEditMode = true;
            ModalCheck.Open();
        }
        else if (tempGoalDay != null && !isInCheck)
        {
            modalGoalDay = tempGoalDay;
            isModalInEditMode = true;
            Modal.Open();
        }
        else if (!isInCheck)
        {
            TimeSpan genetaredTime = goal.StartDateGenerated.TimeOfDay;
            modalGoalDay = new GoalDay { IsAllDay = goal.IsAllDayGenerated, StartDate = currentDay.Date + genetaredTime, LengthTime = goal.LengthTimeGenerated };
            isModalInEditMode = false;
            Modal.Open();
        }

    }


    private void recalculate(int recalculateMode)
    {
        if (recalculateMode == 0)
        {
            DistributeTotalValueToDays(modalGoalDay);
        }
        else if (recalculateMode == 1)
        {
            RecalcutateTotalValue();
        }
    }


    private void DistributeTotalValueToDays(GoalDay excludedday)
    {
        int totalValue = goal.TotalValue;
        int daysCount = goal.Days.Count;

        if (excludedday != null && goal.Days.Contains(excludedday)) // when removing day, day is already not is list
        {
            totalValue -= excludedday.Value;

            daysCount--;


        }

        int Value = totalValue / daysCount;
        int RestofValue = totalValue % daysCount;

        foreach (GoalDay day in goal.Days)
        {
            if (day != excludedday)
            {
                day.Value = Value;
            }
        }
        int i = 0;
        while (RestofValue > 0)
        {
            if (goal.Days[i] != excludedday)
            {
                goal.Days[i].Value++;
                RestofValue--;
            }
            i++;
        }
    }


    private void RecalcutateTotalValue()
    {
        int totalValue = 0;

        foreach (GoalDay day in goal.Days)
        {
            totalValue += day.Value;
        }

        goal.TotalValue = totalValue;
    }



    private void createGoalDay()
    {
        goal.Days.Add(modalGoalDay);
        goal.Days.Sort();
        int indexNewDay = goal.Days.IndexOf(modalGoalDay); //checkboxesChecked array has to be increased by 1 element, index of new Goal Day is saved

        bool[] checkboxesCheckedTemp = new bool[checkboxesChecked.Length + 1];
        int j = 0;
        for (int i = 0; i < checkboxesChecked.Length; i++)
        {
            if (i == indexNewDay) // when index of newly created Goal day index is encountered false value is assing to at and index of newly created array is also increased
            {
                checkboxesCheckedTemp[j++] = false;

            }
            checkboxesCheckedTemp[j++] = checkboxesChecked[i]; // in same passage (no else here!!) value is also copyed from original array, so j is increaed twice, new array is inceased by 1 so it matches
        }
        checkboxesChecked = checkboxesCheckedTemp;

    }


    private void deleteGoalDay()
    {
        int indexDeleteDay = goal.Days.IndexOf(modalGoalDay); //checkboxesChecked array has to be decreased by 1 element, index of deleted Goal Day is saved
        goal.Days.Remove(modalGoalDay);

        bool[] checkboxesCheckedTemp = new bool[checkboxesChecked.Length - 1];
        int j = 0;
        for (int i = 0; i < checkboxesChecked.Length; i++)
        {
            if (i == indexDeleteDay) // when index of newly created Goal day index is encountered assigning values is skipped, j index is not incresed in this passage
            {
                continue;

            }
            checkboxesCheckedTemp[j++] = checkboxesChecked[i]; // in same passage (no else here!!) value is also copyed from original array, so j is increaed twice, new array is inceased by 1 so it matches
        }
        checkboxesChecked = checkboxesCheckedTemp;
    }


    private async Task Refresh()
    {
        Console.WriteLine("****refresh");
        //InitializeCalendar();
        //if (isInCheck)
        //{

        //await JSRuntime.InvokeVoidAsync("destroyChart");
        //await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues, checkedValues);
        // }
        StateHasChanged();
    }


    public void InitializeCalendar()
    {
        startCalendarDay = goal.Days.ElementAt(0).StartDate;

        var startDayNumber = (int)startCalendarDay.DayOfWeek;
        startDayNumber = startDayNumber == 0 ? 7 : startDayNumber;

        firstCalendarDay = startCalendarDay.AddDays(-startDayNumber + 1);
        endCalendarDay = goal.Days.ElementAt(goal.Days.Count - 1).StartDate;

        currentCalendarDay = firstCalendarDay;
        dayIndex = 0;
        lastPrintedMonth = -1;
    }


    //protected async override Task OnParametersSetAsync()
    protected override void OnParametersSet()
    {
        if (goal == null)
        {
            base.OnParametersSet();
            return;
        }

        /*
        if (isInEdit && !isInCheck)
        {
        //originalGoal = goal.


        base.OnParametersSet();

        }
        */

        checkboxesChecked = new bool[goal.Days.Count];
        InitializeCalendar();
        isCalendarVisible = true;
        DistributeTotalValueToDays(null);
        base.OnParametersSet();
        //await JSRuntime.InvokeVoidAsync("destroyChart");
        //await JSRuntime.InvokeVoidAsync("drawChart", dates, cumulativeValues, checkedValues);
        //Refresh()
        //await Refresh();

    }
}
